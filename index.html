<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Document</title>
	<script type="text/javascript" src="generate-qr/jquery.min.js"></script>
	<script type="text/javascript" src="generate-qr/qrcode.js"></script>
	<link rel="stylesheet" href="style.css">
</head>
<body>
<input id="key" type="text" placeholder="Chave PIX">
<input id="amount" type="text" placeholder="Valor">
<input id="name" type="text" placeholder="Nome BeneficiÃ¡rio">
<input id="city" type="text" value="Sao Paulo" placeholder="Cidade">
<input id="identifier" type="text" value="***" placeholder="Identificador">
<button onclick="generateQRCode()">Generate PIX</button>
<div id="qrcode"></div>
<img id="qrimage">
<script type="text/javascript">
function padLength(length) {
	return length.toString().padStart(2, '0');
}

function generateQRData() {
	const key = document.getElementById("key").value;
	const amount = document.getElementById("amount").value;
	const name = document.getElementById("name").value;
	const city = document.getElementById("city").value;
	const identifier = document.getElementById("identifier").value;

	var amountString = "";
	if (amount != "") {
		amountString = "54" + padLength(amount.length) + amount;
	}
	let qrdata = "00020126" + padLength(key.length + 22) + "0014BR.GOV.BCB.PIX01" + padLength(key.length) + key + "520400005303986" + amountString + "5802BR59" + padLength(name.length) + name + "60" + padLength(city.length) + city + "62" + padLength(identifier.length + 4) + "05" + padLength(identifier.length) + identifier + "6304";
	qrdata += crc16Ccitt(qrdata);

	return qrdata;
}

function crc16Ccitt(data) {
	const polynomial = 0x1021;
	let crc = 0xFFFF;

	for (let i = 0; i < data.length; i++) {
		crc ^= data.charCodeAt(i) << 8;
		for (let j = 0; j < 8; j++) {
			if ((crc & 0x8000) !== 0) {
				crc = (crc << 1) ^ polynomial;
			} else {
				crc <<= 1;
			}
			crc &= 0xFFFF;
		}
	}

	return crc.toString(16).toUpperCase().padStart(4, '0');
}

function generateQRCode() {
	const qrdata = generateQRData();
	console.log(qrdata);

	new QRCode(document.getElementById("qrcode"), {
		text: qrdata,
		colorDark: "#000000",
		colorLight: "#ffffff",
		correctLevel: QRCode.CorrectLevel.H,
		useSVG: true
	});

	// Wait a bit for the QRCode library to generate the SVG
	setTimeout(() => {
		const svgElement = document.querySelector("#qrcode svg");
		const serializer = new XMLSerializer();
		const svgString = serializer.serializeToString(svgElement);
		const svgBlob = new Blob([svgString], {type: "image/svg+xml;charset=utf-8"});
		const url = URL.createObjectURL(svgBlob);

		const imgElement = document.getElementById("qrimage");
		imgElement.src = url;
	}, 100); // Adjust the delay if necessary
}
</script>
</body>
</html>
